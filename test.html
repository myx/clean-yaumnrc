<html>
	<head>
		<script>
			var module = { export : {} };
		</script>
		<script src="index.js"></script>
		<style>
				HTML, BODY {
					position: absolute;
					left: 0;
					top: 0;
					width: 100%;
					height: 100%;
					overflow: hidden;
					padding: 0;
					margin: 0;
				}
				TEXTAREA {
					width: 50%;
					height: 100pt;
					font: monospaced;
					vertical-align: top;
				}
				blockquote {
					font-size: 90%;
					line-height: 1em;
				}
				#lpanel {
					position: absolute;
					left: 0;
					top: 0;
					height: calc(100% - 1em);
					width: 15em;
					line-height: 1.31em;
					overflow: auto;
					padding: 0.5em;
				}
				.lpanelItem {
					display: block;
				}
				#output {
					position: absolute;
					left: 0;
					top: 0;
					width: calc(100% - 15em - 3em);
					height: calc(100% - 2em);
					margin-left: 16em;
					overflow: scroll;
					line-height: 1.1em;
					padding: 1em;
				}
		</style>		
		<script>
			function test(){
				const Config = module.exports;
				const config = Config.parse({
					"locations" : {
						"h1" : {
							"name" : "h1.myx.ru",
							"wan3" : "h1-wan",
							"lan3" : "192.168.1.250",
							"tap3" : "10.112.11.20"
						},
						"h2" : {
							"name" : "h2.myx.ru",
							"wan3" : "h2-wan"
						},
						"o3" : {
							"name" : "o3.myx.ru",
							"wan3" : "o3-wan",
							"lan3" : [
								"192.168.3.250", 
								"010.001.002.001/16", 
								"10.2.2.2/16", 
								{
									"key": "lan323",
									"ip" : "10.3.2.3/16"
								}
							],
							"tap3" : "10.112.21.20" 
						},
						"h5" : {
							"name" : "h5.myx.ru",
							"wan3" : "h5-wan",
							"lan3" : "192.168.5.250",
							"tap3" : "10.112.55.20"
						},
						"g1" : {
							"name" : "g1.myx.ru",
							"title" : "GCP (Google Cloud Platform)"
						},
						"a1" : {
							"name" : "a1.myx.ru",
							"title" : "AWS (Amazon Web S?)"
						}
					},
					"servers" : {
						"l6h1.myx.ru" : {
							"router" : "active",
							"location" : "h1",
							"wan" : {
								"ip" : "l6h1-wan"
							},
							"lan" : {
								"mac" : "AA:BB:CC:DD:EE:FF",
								"ip" : "192.168.1.254"
							},
							"tap" : { 
								"ip" : "l6h1-tap",
								"key" : "-----BEGIN RSA PUBLIC KEY-----\r\nMIIBCgKCAQEA1u1UJ1/rKCT2pVPgSAvLWeZ2RW2e72ObC7xG1YVBMUi1V8JCU0+S\r\ntEaEgNknTxNylJm2OiE50YWZzydDMf+GNq3AEqq/9S9UZRuZQlxSbTe4Ic1odgdi\r\nXMZHdMJu3Q4AOCxu8kEHGR4VelvpprjHyZxEteZ/doBSGm4TaomaAT3gI0k5TAol\r\nacjoctu+dgrL1YZA0MtPYAN0JX5yeLA0yZ7AKeHfGW5Ws5E5++Y1QdE3XNXxftL4\r\nX9dhOJBziW4TsPYTpair2oLLcmOYihnD6Bbsb87aoaKt6iheEtVzBgluN+qhzCP1\r\nA5ZgIlicbLrwHD61o83lpatE/dNDbhKVvQIDAQAB\r\n-----END RSA PUBLIC KEY-----"
							}
						},
						"l6o3.myx.ru" : {
							"router" : "active",
							"location" : "o3",
							"wan" : {
								"ip" : "l6o3-wan"
							},
							"lan" : {
								"ip" : "192.168.3.254"
							},
							"tap" : { 
								"ip" : "l6o3-tap",
								"key" : "-----BEGIN RSA PUBLIC KEY-----\r\nMIIBCgKCAQEA1u1UJ1/rKCT2pVPgSAvLWeX2RW2e72ObC7xG1YVBMUi1V8JCU0+S\r\ntEaEgNknTxNylJm2OiE50YWXzydDMf+GNq3AEqq/9S9UXRuXQlxSbTe4Ic1odgdi\r\nXMXHdMJu3Q4AOCxu8kEHGR4VelvpprjHyXxEteX/doBSGm4TaomaAT3gI0k5TAol\r\nacjoctu+dgrL1YXA0MtPYAN0JX5yeLA0yX7AKeHfGW5Ws5E5++Y1QdE3XNXxftL4\r\nX9dhOJBziW4TsPYTpair2oLLcmOYihnD6Bbsb87aoaKt6iheEtVzBgluN+qhzCP1\r\nA5XgIlicbLrwHD61o83lpatE/dNDbhKVvQIDAQAB\r\n-----END RSA PUBLIC KEY-----"
							}
						},
						"stdalone1-h1.myx.ru" : {
							"location" : "h1",
							"wan" : {
								"ip" : "stdalone1-h1.wan"
							},
							"lan" : {
								"ip" : "192.168.1.77"
							}
						},
						"stdalone2-h1.myx.ru" : {
							"location" : "h1",
							"wan" : {
								"ip" : "stdalone2-h1.wan"
							},
							"lan" : {
								"ip" : "192.168.1.79"
							}
						},
						"stdalone3-h1.myx.ru" : {
							"location" : "h1",
							"wan" : {
								"ip" : "stdalone3-h1.wan"
							},
							"lan" : {
								"ip" : "7.7.7.7"
							}
						},
						"ae3.myx.ru" : {
							"location" : "h1"
						},
						"www-h1.myx.ru" : {
							"location" : "h1",
							"net" : "www",
							"lan" : {
								"mac" : "AA:BB:CC:00:01:01",
								"ip" : "192.168.1.77"
							}
						},
						"www-o3.myx.ru" : {
							"location" : "o3",
							"net" : "www",
							"lan" : {
								"mac" : "AA:BB:CC:03:01:01",
								"ip" : "192.168.3.77"
							}
						},
						"mpxy1.myx.ru" : {
							"location" : "h1",
							"net" : "monitoring",
							"wan" : {
								"ip" : "mpxy1-wan"
							},
							"lan" : {
								"ip" : "192.168.1.27"
							}
						},
						"mpxy3.myx.ru" : {
							"location" : "o3",
							"net" : "monitoring",
							"lan" : {
								"ip" : "192.168.3.27"
							}
						}
					},
					"routing" : {
						"domains" : {
							".myx.co.nz" : {
								"mode" : "infrastructure"
							},
							".myx.ru" : {
								"mode" : "infrastructure",
								"dns" : {
									"A" : {
										"*" : "5.9.34.107",
										"@" : "5.9.100.81"
									},
									"CNAME" : {
										"cgit.myx.co.nz." : "yandex.googlehosted.com."
									}
								}
							},
							".ded.myx.ru" : {
								"mode" : "dedicated",
								"dns" : {
									"A" : {
										"*" : "5.9.34.107",
										"@" : "5.9.100.81"
									},
									"CNAME" : {
										"cgit.myx.co.nz." : "yandex.googlehosted.com."
									}
								}
							},
							".del.myx.ru" : {
								"mode" : "delegated",
								"servers" : [
									"ns1.keen.com", 
									"ns2.keen.com"
								]
							},
							".sta.myx.ru" : {
								"mode" : "static",
								"dns" : {
									"NS" : {
										"@" : [
											"l3o1.ndm9.net.",
											"l3h1.ndm9.net.",
											"l3r2.ndm9.net."
										]
									},
									"A" : {
										"*" : "55.9.34.107",
										"@" : "55.9.100.81"
									},
									"AAAA" : {
										"@"   : "2a01:4f8:160:30c1:0:0:0:2",
										"www" : "2a01:4f8:160:30c1:0:0:0:2"
									},
									"MX" : {
										"@" : [
											"5 aspmx.l.google.com.",
											"10 alt1.aspmx.l.google.com.",
											"15 alt2.aspmx.l.google.com."
										]
									},
									"CNAME" : {
										"zinka.sta.myx.ru." : "www.microsoft.com."
									}
								}
							},
							".sla.myx.ru" : {
								"mode": "slave",
								"masters": ["5.9.100.67", "172.16.111.11", "172.16.121.11"]
							}
						}
					},
					"targets" : {
						"h1.myx.ru" : {
							"target" : "l6h1.myx.ru"
						},
						"o3.myx.ru" : {
							"location" : "o3",
							"target" : "l6o2.myx.ru",
							"dns" : "use-router",
							"ssl" : "strong"
						},
						"l6o3.myx.ru" : {
							"target" : "l6o3.myx.ru",
							"ssl" : "strong"
						},
						"l6.myx.ru" : {
							"target" : [ "l6h1.myx.ru", "l6o3.myx.ru" ]
						},
						"stdalone2-h1.myx.ru" : {
							"target" : "stdalone2-h1.myx.ru",
							"dns" : "ignore-wan"
						},
						"stdalone3-h1.myx.ru" : {
							"target" : "stdalone2-h1.myx.ru",
							"dns" : "ignore-wan"
						},
						"stdalone.myx.ru" : {
							"target" : [
								"stdalone1-h1.myx.ru", 
								"stdalone2-h1.myx.ru", 
								"stdalone3-h1.myx.ru"
							]
						},
						"www.myx.ru" : {
							"target" : [
								"www-h1.myx.ru",
								"www-o3.myx.ru"
							]
						},
						"web.myx.ru" : {
							"target" : "l6.myx.ru"
						},
						"zyx.myx.ru" : {
							"target" : "zyxel.myx.ru"
						},
						"zyxel.myx.ru" : {
							"proxyHttp" : "http://zyxel.ru",
							"proxyHttps" : "https://zyxel.ru"
						},
						"mpxy-direct.myx.ru" : {
							"target" : ["mpxy1.myx.ru", "mpxy3.myx.ru"],
							"dns" : "direct"
						},
						"mpxy-default.myx.ru" : {
							"target" : ["mpxy1.myx.ru", "mpxy3.myx.ru"]
						},
						"mpxy-router.myx.ru" : {
							"target" : ["mpxy1.myx.ru", "mpxy3.myx.ru"],
							"dns" : "use-router"
						},
						"mpxy-def-h1l.myx.ru" : {
							"location" : "h1",
							"target" : ["mpxy1.myx.ru", "mpxy3.myx.ru"]
						},
						"capandcap.ru" : {
							"target" : [
								"http://capandcap.ru",
								"https://canandcap.ru"
							]
						},
						"bcp-h1.myx.ru" : {
							"location" : "h1",
							"proxyHttp" : "http://maersk.myx.ru:5001", 
							"proxyHttps" : "http://maersk.myx.ru:5001",
							"ssl" : "ndm-strong-VG"
						},

						"bcp-aw.myx.ru" : {
							"proxyHttp" : "http://buildproxy-env.eu-central-1.elasticbeanstalk.com", 
							"proxyHttps" : "http://buildproxy-env.eu-central-1.elasticbeanstalk.com",
							"ssl" : "ndm-strong-VG"
						},


						"bcp-o3.myx.ru" : {
							"location" : "o3",
							"proxyHttp" : "http://sovtransavto.myx.ru:5001", 
							"proxyHttps" : "http://sovtransavto.myx.ru:5001",
							"ssl" : "ndm-strong-VG"
						},

						"bcp.myx.ru" : {
							"target" : [
								"bcp-h1.myx.ru",
								"bcp-o3.myx.ru",
								"bcp-aw.myx.ru"
							]
						},
					},
				});
				
				const output = document.getElementById('output');
				const lpanel = document.getElementById('lpanel');

				let target = output;

				function out(t,x,e,d){
					switch(arguments.length){
						case 0:
							d = document.createElement('hr');
							break;
						case 1:
							d = document.createElement('h2');
							d.innerHTML = t;
							break;
						default:
							d = document.createElement('div');
							t && (d.innerHTML = t + ": ");
							e = document.createElement(e || 'pre')
							e.innerHTML = x;
							d.appendChild(e);
					}
					target.appendChild(d);
				}

				var stackLevel = 0;

				function push(title, id){
					let e, t = target;
					title && (e = document.createElement('h2'), e.innerHTML = title, t.appendChild(e));
					id && (e.id = id);
					t = document.createElement('blockquote');
					t.parent = target;
					target.appendChild(t);
					target = t;
					++stackLevel;
				}

				function pop(){
					target = target.parent || output;
					--stackLevel;
				}


				var bmIndex = 0;

				function nest(title, f){
					const index = ++bmIndex;
					if(stackLevel < 5){
						{
							const item = document.createElement("a");
							item.className = "lpanelItem";
							item.href = "#bm" + index;
							item.style.paddingLeft = stackLevel + "em";
							item.innerHTML = title;
							lpanel.appendChild(item);
						}
						{
							const item = document.createElement("span");
							item.innerHTML = "<a id=bm" + index + "/>";
							//target.appendChild(item);
						}
					}

					push(title, 'bm' + index);
					f();
					pop();
				}
				
				nest("Basics", function(){
					out('Config' + config);
					out('Locations', config.locations);
					out('Servers', config.servers);
					out('Routers', config.routers);

					function resolve(host){
						out(' Config.resolveForHost("'+host+'")', config.resolveForHost(host));
					}
					resolve("l6h1.myx.ru");
					resolve("l6h1.myx.co.nz");
					resolve("l6o3.myx.ru");
					resolve("l6o3.myx.co.nz");
					resolve("mpxy-direct.myx.ru");
					resolve("mpxy-default.myx.ru");
					resolve("mpxy-direct.myx.co.nz");
					resolve("mpxy-default.myx.co.nz");
				});

				nest('Locations', function(){

					for(var l of config.locations.list){
						const name = l.key;
						nest(name, function(){
							out('Location', l);
							const view = config.makeView(name);
							out(' Location.config', view);
							const location = view.location;
							out(' Location.location', location);
							out(' Location.lans', location.lans);
							out(' Location.lan3', location.lan3);
							out(' Location.servers', location.servers);
							out(' Location.routers', location.routers);
		
							function resolve(host){
								out(' Location.resolveForHost("'+host+'")', location.resolveForHost(host));
							}
							resolve("l6h1.myx.ru");
							resolve("l6h1.myx.co.nz");
							resolve("l6o3.myx.ru");
							resolve("l6o3.myx.co.nz");
							resolve("mpxy-direct.myx.ru");
							resolve("mpxy-default.myx.ru");
							resolve("mpxy-direct.myx.co.nz");
							resolve("mpxy-default.myx.co.nz");
							
							if(location.lans) for(var lan of location.lans.list){
								out(' Lan(' + lan + ').key', lan.key);
								out(' Lan(' + lan + ').ip', lan.ip);
								out(' Lan(' + lan + ').intIPv4', lan.intIPv4);
								out(' Lan(' + lan + ').strIPv4', lan.strIPv4);
								out(' Lan(' + lan + ').bits', lan.bits);
								out(' Lan(' + lan + ').mask', lan.mask);
								out(' Lan(' + lan + ').network', lan.network);
								out(' Lan(' + lan + ').networkInt', lan.networkInt);
								out(' Lan(' + lan + ').networkCidr', lan.networkCidr);
								out(' Lan(' + lan + ').location', lan.location);
							}
							
							out(".provisionView.toSource()", location.provisionView.toSource(), 'textarea');
		
							out(".toSource()", location.toSource(), 'pre');
		
							out();
						});
					}
				});
				
				
				function dumpServer(server){
					const name = server.key;
					nest(name, function(){
						out('Server', server);
						out('.location', server.location);
						out('.wan3', server.wan3);
						out('.lan3', server.lan3);
						out('.wan3smart', server.wan3smart);
						out('.lan3smart', server.lan3smart);
		
						// temp array - it is not array for now
						for(let lan of [].concat(server.lan3)){
							lan && out('Gateway(for '+lan+') ', server.location.networkForClient(lan));
						}

						out(' .toSource()', server.toSource());
						out();
					});
				}
				

				nest('Routers', function(){
					for(let s of config.routers.list){
						dumpServer(s);
					}
				});
				

				nest('Servers', function(){
					for(let s of config.servers.list){
						dumpServer(s);
					}
				});
				

				function dumpDomains(view){
					out("Domains", view);
					out(".toSource()", view.toSource(), 'textarea');
					for(var d of view.list){
						nest(d.key, function(){
							out(".toSource()", d.toSource(), 'pre');
						});
					}
				}

				nest('WAN DNS', function(){
					dumpDomains(config.buildDnsView(null));
				});
				

				nest('Config (sources)', function(){
					nest('Config.Source', function(){
						out('', config.toSource(), 'textarea');
						out('', config.toSource(), 'pre');
					});
					nest('Config.SourceNonSecure', function(){
						out('', config.toSourceNonSecure(), 'textarea');
						out('', config.toSourceNonSecure(), 'pre');
					});
				});
				

				nest('Config Views', function(){
					function configView(x){
						nest('Looking from: ' + x, function(){
							const viewS = config.makeView(x);
							
							out('Config.servers["'+x+'"].selected', config.servers.map[x].selected);
							out('Server.selected', viewS.server.selected);
			
							out('targetListDns', viewS.targetListDns);
							out('Config.wan3smart', viewS.wan3smart);
							out('Location.wan3smart', viewS.location.wan3smart);
							out('Server.wan3smart', viewS.server.wan3smart);
			
							out('Config.lan3smart', viewS.lan3smart);
							out('Location.lan3smart', viewS.location.lan3smart);
							out('Server.lan3smart', viewS.server.lan3smart);

							function dumpTarget(target){
								const name = target.key;
								nest(name, function(){
									out('Target', target);
									out(' .location', target.location);
									out(' .modeDns', target.modeDns);
									out(' .wan3smart', target.wan3smart);
									out(' .endpointsList', target.endpointsList);
									out(' .toSource()', target.toSource());
									out();
								});
							}

							nest('Routers', function(){
								for(let target of viewS.routers.list){
									dumpTarget(target);
								}
							});

							nest('Servers', function(){
								for(let target of viewS.servers.list){
									dumpTarget(target);
								}
							});

							nest('Targets', function(){
								for(let target of viewS.targetListDns){
									dumpTarget(target);
								}
							});

							nest('WAN DNS', function(){
								dumpDomains(viewS.buildDnsView(null));
							});

							nest('LAN DNS', function(){
								dumpDomains(viewS.buildDnsView(Config.Networks.LOCAL));
							});

							nest('LOC DNS', function(){
								dumpDomains(viewS.buildDnsView(viewS.location.lans));
							});

							
							nest('DHCP', function(){
								function dumpDhcpView(view){
									nest("View: " + view.location.key, function(){
										out('DhcpView', view);
										for(var host of view.list){
											nest('Host: ' + host.key, function(){
												const mac = host.mac;
												out('DhcpHost', host);
												out('.key', host.key);
												out('.mac', host.mac);
												out('.ip', host.ip);
												out('.host', host.host);
												out('.gateway', host.gateway);
												out('.network', host.network);
												out('.networkIp', host.networkIp);
												out('.networkMask', host.networkMask);
												out('.networkBits', host.networkBits);
												out('.networkCidr', host.networkCidr);
												nest('.routes', function(){
													for(var r of (host.routes || [])){
														out(null, r);
													}
												});
											});
										}
									});
								}
				
								dumpDhcpView(viewS.location.provisionView);
							});
						});
					}
	
					for(let router of config.routers.list){
						configView(router.key);
					}
				});
				
			}
		</script>
	</head>
	<body onload="test()">
		<div id="lpanel">
		</div>
		<div id="output">
		</div>
	</body>
</html>