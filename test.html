<html>
	<head>
		<script>
			var module = { export : {} };
		</script>
		<script src="index.js"></script>
		<style>
				TEXTAREA {
					width: 50%;
					height: 100pt;
					vertical-align: top;
				}
		</style>		
		<script>
			function test(){
				var Config = module.exports;
				var config = Config.parse({
					"locations" : {
						"h1" : {
							"name" : "h1.myx.ru",
							"wan3" : "h1-wan",
							"lan3" : "192.168.1.250",
							"tap3" : "10.112.11.20"
						},
						"h2" : {
							"name" : "h2.myx.ru",
							"wan3" : "h2-wan"
						},
						"o3" : {
							"name" : "o3.myx.ru",
							"wan3" : "o3-wan",
							"lan3" : [
								"192.168.3.250", 
								"10.1.2.1/16", 
								"10.2.2.2/16", 
								"10.3.2.3/16"
							],
							"tap3" : "10.112.21.20" 
						},
						"g1" : {
							"name" : "g1.myx.ru",
							"title" : "GCP (Google Cloud Platform)"
						},
						"a1" : {
							"name" : "a1.myx.ru",
							"title" : "AWS (Amazon Web S?)"
						}
					},
					"servers" : {
						"l6h1.myx.ru" : {
							"router" : "active",
							"location" : "h1",
							"wan" : {
								"ip" : "l6h1-wan"
							},
							"lan" : {
								"ip" : "192.168.1.254"
							},
							"tap" : { 
								"ip" : "l6h1-tap",
								"key" : "-----BEGIN RSA PUBLIC KEY-----\r\nMIIBCgKCAQEA1u1UJ1/rKCT2pVPgSAvLWeZ2RW2e72ObC7xG1YVBMUi1V8JCU0+S\r\ntEaEgNknTxNylJm2OiE50YWZzydDMf+GNq3AEqq/9S9UZRuZQlxSbTe4Ic1odgdi\r\nXMZHdMJu3Q4AOCxu8kEHGR4VelvpprjHyZxEteZ/doBSGm4TaomaAT3gI0k5TAol\r\nacjoctu+dgrL1YZA0MtPYAN0JX5yeLA0yZ7AKeHfGW5Ws5E5++Y1QdE3XNXxftL4\r\nX9dhOJBziW4TsPYTpair2oLLcmOYihnD6Bbsb87aoaKt6iheEtVzBgluN+qhzCP1\r\nA5ZgIlicbLrwHD61o83lpatE/dNDbhKVvQIDAQAB\r\n-----END RSA PUBLIC KEY-----"
							}
						},
						"l6o3.myx.ru" : {
							"router" : "active",
							"location" : "o3",
							"wan" : {
								"ip" : "l6o3-wan"
							},
							"lan" : {
								"ip" : "192.168.3.254"
							},
							"tap" : { 
								"ip" : "l6o3-tap",
								"key" : "-----BEGIN RSA PUBLIC KEY-----\r\nMIIBCgKCAQEA1u1UJ1/rKCT2pVPgSAvLWeX2RW2e72ObC7xG1YVBMUi1V8JCU0+S\r\ntEaEgNknTxNylJm2OiE50YWXzydDMf+GNq3AEqq/9S9UXRuXQlxSbTe4Ic1odgdi\r\nXMXHdMJu3Q4AOCxu8kEHGR4VelvpprjHyXxEteX/doBSGm4TaomaAT3gI0k5TAol\r\nacjoctu+dgrL1YXA0MtPYAN0JX5yeLA0yX7AKeHfGW5Ws5E5++Y1QdE3XNXxftL4\r\nX9dhOJBziW4TsPYTpair2oLLcmOYihnD6Bbsb87aoaKt6iheEtVzBgluN+qhzCP1\r\nA5XgIlicbLrwHD61o83lpatE/dNDbhKVvQIDAQAB\r\n-----END RSA PUBLIC KEY-----"
							}
						},
						"ae3.myx.ru" : {
							"location" : "h1"
						},
						"mpxy1.myx.ru" : {
							"location" : "h1",
							"wan" : {
								"ip" : "mpxy1-wan"
							},
							"lan" : {
								"ip" : "192.168.1.27"
							}
						},
						"mpxy3.myx.ru" : {
							"location" : "o3",
							"lan" : {
								"ip" : "192.168.3.27"
							}
						}
					},
					"routing" : {
						"domains" : {
							".myx.co.nz" : {
								"mode" : "infrastructure",
								"dns" : {
									"A" : {
										"*" : "5.9.34.107",
										"@" : "5.9.100.81"
									},
									"CNAME" : {
										"nsc46uvvjmnf.cgit.ndm9.net." : "gv-m6frfsjni3q2d2.dv.googlehosted.com."
									}
								}
							},
							".myx.ru" : {
								"mode" : "infrastructure"
							},
							".del.myx.ru" : {
								"mode" : "dedicated"
							},
							".sta.myx.ru" : {
								"mode" : "static"
							},
							".sla.myx.ru" : {
								"mode" : "slave"
							}
						}
					},
					"targets" : {
						"h1.myx.ru" : {
							"target" : "l6h1.myx.ru"
						},
						"o3.myx.ru" : {
							"location" : "o3",
							"target" : "l6o2.myx.ru",
							"dns" : "use-router",
							"ssl" : "strong"
						},
						"l6o3.myx.ru" : {
							"target" : "l6o3.myx.ru",
							"ssl" : "strong"
						},
						"l6.myx.ru" : {
							"target" : [ "l6h1.myx.ru", "l6o3.myx.ru" ]
						},
						"web.myx.ru" : {
							"target" : "l6.myx.ru"
						},
						"zyx.myx.ru" : {
							"target" : "zyxel.myx.ru"
						},
						"zyxel.myx.ru" : {
							"proxyHttp" : "http://zyxel.ru",
							"proxyHttps" : "https://zyxel.ru"
						},
						"mpxy-direct.myx.ru" : {
							"target" : ["mpxy1.myx.ru", "mpxy3.myx.ru"],
							"dns" : "direct"
						},
						"mpxy-default.myx.ru" : {
							"target" : ["mpxy1.myx.ru", "mpxy3.myx.ru"]
						},
						"zyxel.myx.ru" : {
							"target" : [
								"http://zyxel.ru",
								"https://zyxel.ru"
							]
						}
					},
				});
				
				var output = document.getElementById('output');
				function out(t,x,e,d){
					switch(arguments.length){
						case 0:
							d = document.createElement('hr');
							break;
						case 1:
							d = document.createElement('h2');
							d.innerHTML = t;
							break;
						default:
							d = document.createElement('div');
							d.innerHTML = t + ": ";
							e = document.createElement(e || 'pre')
							e.innerHTML = x;
							d.appendChild(e);
					}
					output.appendChild(d);
				}
				
				out('Config', config);
				out('Locations', config.locations);
				out('Servers', config.servers);
				out('Routers', config.routers);

				function dumpLocation(name){
					out('location: ' + name);
					const view = config.makeView(name);
					out(' Location.config', view);
					out(' Location.location', view.location);
					out(' Location.lans', view.location.lans);
					out(' Location.lan3', view.location.lan3);
					out(' Location.servers', view.location.servers);
					out(' Location.routers', view.location.routers);

					for(var lan of view.location.lans.list){
						out(' Lan(' + lan + ').gway', lan.ip);
						out(' Lan(' + lan + ').intIPv4', lan.intIPv4);
						out(' Lan(' + lan + ').strIPv4', lan.strIPv4);
						out(' Lan(' + lan + ').mask', lan.mask);
						out(' Lan(' + lan + ').netw', lan.networkIp);
					}

					out('');
				}

				dumpLocation('h1');
				dumpLocation('g1');
				
				function dumpServer(name){
					out('server: ' + name);
					var viewS = config.makeView(name);
					
					out('Config', viewS);
					out('Location', viewS.location);
					out('Server', viewS.server);
					out('Router', viewS.router);

					// temp array - it is not array for now
					for(var lan of ([viewS.server.lan3] || [])){
						out('Gateway(for '+lan+') ', viewS.location.findGatewayForClient(lan));
					}
	
					out('Location.lans', viewS.location.lans);
					out('Location.servers', viewS.location.servers);
					out('Location.routers', viewS.location.routers);
	
					out('Location.wan3', viewS.location.wan3);
					out('Location.lan3', viewS.location.lan3);
	
					out('Router.wan3', viewS.router.wan3);
					out('Router.lan3', viewS.router.lan3);
	
					out('Router.location', viewS.router.location);
				}

				dumpServer('l6h1.myx.ru');
				

				out('Config');
				out('Config.Source', config.toSource());
				

				out('Looking from: l6h1.myx.ru');
				var viewS = config.makeView('l6h1.myx.ru');
				
				out('Config.servers["l6h1.myx.ru"].selected', config.servers.map["l6h1.myx.ru"].selected);
				out('Server.selected', viewS.server.selected);

				out('targetListDns', viewS.targetListDns);
				out('wan3smart', viewS.wan3smart);
				out('Server.wan3smart', viewS.server.wan3smart);

				function dumpTarget(name){
					out('target: ' + name);
					const target = viewS.targets.map[name] || viewS.servers.map[name];
					const global = config.targets.map[name] || config.servers.map[name];
					out(' Global', global);
					out(' Target', target);
					out(' Target.location', target.location);
					out(' Target.modeDns', target.modeDns);
					out(' Target.wan3smart', target.wan3smart);
					out(' Global.endpointsList', global.endpointsList);
					out(' Target.endpointsList', target.endpointsList);
					out('');
				}

				dumpTarget('l6.myx.ru');
				dumpTarget('l6h1.myx.ru');
				dumpTarget('l6o3.myx.ru');
				dumpTarget('o3.myx.ru');
				dumpTarget('zyxel.myx.ru');
				dumpTarget('web.myx.ru');
				dumpTarget('mpxy-direct.myx.ru');
				dumpTarget('mpxy-default.myx.ru');
				

				function dumpDns(view){
					out("DNS, " + view);
					out("DNS-WAN", JSON.stringify(view.buildDnsView(null).toSourceObject(), null, 4), 'pre');
					out("DNS-LAN", JSON.stringify(view.buildDnsView(Config.Networks.LOCAL).toSourceObject(), null, 4), 'pre');
				}

				dumpDns(config);
				dumpDns(viewS);
				
			}
		</script>
	</head>
	<body onload="test()">
		<div id="output">
		</div>
	</body>
</html>